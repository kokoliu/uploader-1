/*!
 * jQuery HTML5 Upload plugin
 *
 * Copyright (c) 2011 Stefan Benicke
 *
 * Dual licensed under the MIT and GPL licenses
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */
(function(e){var h={url:"./",multiple:true,buttonText:"Upload",eventNamespace:"uploader",bandwidthInterval:1000,onSubmit:function(i){},onProgress:function(j,i,k){},onComplete:function(j,i){},onError:function(i,j){},onCancel:function(i,j){},},g=0,c,f,b=function(){var i=e('<input type="file"/>')[0];c=("multiple" in i&&typeof File!="undefined"&&typeof(new XMLHttpRequest()).upload!="undefined")},a=function(){var i=e("<progress/>").appendTo("body");f="value" in i[0];i.remove()},d=function(j){j=parseFloat(j);var k=0;while(j>1023){j/=1024;k++}if(k>0){j=j.toFixed(2)}return j+" "+["Bytes","kB","MB","GB","TB","PB","EB"][k]};b();a();e.fn.uploader=function(i){i=e.extend({},h,i);return this.each(function(){var z=e(this),y,u,o,k,D,s,w,r=function(){if(c){p(k[0].files)}else{m()}},p=function(I){if(typeof I=="undefined"){return}for(var H=0,G=I.length;H<G;H++){C(I[H])}},C=function(L){var H=L.fileName||L.name,V=L.fileSize||L.size,T=L.fileType||L.type,Q,N=0,G=n(H,V),S=function(Z){if(Z.lengthComputable){var Y=Math.round((Z.loaded/Z.total)*100);var X="n/a";var W=new Date().getTime();if((W-Q)>=i.bandwidthInterval){X=d((Z.loaded-N)/((W-Q)/1000))+"/s";Q=W;N=Z.loaded;G.bandwidth.html("("+X+")")}if(G.progress){G.progress.val(Y)}G.percent.html(Y+"%");i.onProgress.call(G.list,H,Z.loaded,Z.total)}},P=function(){response={};if(U.readyState==4){if(U.status==200){response=U.responseText;M()}i.onComplete.call(G.list,H,response)}},O=function(W){K();i.onError.call(G.lost,H,U.statusText)},J=function(W){K();i.onCancel.call(G.lost,H,U.statusText)},R=function(){U.abort()},K=function(){G.list.addClass("upload-failed");G.abort.hide();G.percent.hide();G.bandwidth.hide();if(G.progress){G.progress.hide()}},M=function(){G.list.addClass("upload-success");G.abort.hide();G.percent.hide();G.bandwidth.hide();if(G.progress){G.progress.hide()}},U=new XMLHttpRequest();if(U.upload){U.upload.addEventListener("progress",S,false)}U.onreadystatechange=P;if(U.addEventListener){U.addEventListener("error",O,false);U.addEventListener("abort",J,false)}U.open("POST",i.url,true);U.setRequestHeader("Content-Type","multipart/form-data");U.setRequestHeader("X-File-Name",H);U.setRequestHeader("X-File-Size",V);U.setRequestHeader("X-File-Type",T);G.abort.bind("click."+i.eventNamespace,R);i.onSubmit.call(G.list,H);try{U.send(L);Q=new Date().getTime()}catch(I){K();i.onError.call(G.list,H,I.message)}},m=function(){var G=k.val().replace(/.*(\/|\\)/,""),H=n(G);i.onSubmit.call(H.list,G);s.data({name:G,fields:H}).submit()},A=function(){var I=s.data("fields"),H=s.data("name"),G=q();I.list.addClass("upload-success");i.onComplete.call(I.list,H,G)},q=function(){var G=w.contents().find("body").html();return G},n=function(G,P){P=P?d(P):"";var L=c?"":' style="display:none"',O,I,N,H,J,M,K=e("<li/>").append(O=e('<span class="upload-status"/>'),I=e('<span class="upload-file">'+G+"</span>"),N=e('<span class="upload-size"'+L+">"+P+"</span>"),J=e('<input type="button" class="upload-abort"'+L+' value="abort"/>'),"<br/>").appendTo(D);if(c&&f){K.append(M=e('<progress max="100"/>'))}K.append(H=e('<span class="upload-percent"'+L+"/>"),$bandwidth=e('<span class="upload-bandwidth"'+L+"/>"));return{list:K,status:O,file:I,size:N,abort:J,progress:M,percent:H,bandwidth:$bandwidth}},E=function(G){j(G);u.show()},l=function(G){j(G);var I=document.elementFromPoint(G.clientX,G.clientY),H=G.srcElement?G.srcElement&&G.srcElement.nodeName=="HTML":true;if(!I||(I&&I.nodeName=="HTML"&&H)){u.hide()}},B=function(G){j(G)},F=function(G){j(G);u.addClass("active")},v=function(G){j(G);u.removeClass("active")},x=function(H){j(H);u.removeClass("active").hide();var G=H.originalEvent.dataTransfer.files||H.dataTransfer.files;p(G);e(document).trigger("wasdropped."+i.eventNamespace)},j=function(G){G.preventDefault();G.stopPropagation()},t=function(){var G=c&&i.multiple?" multiple":"";e(document).bind("dragenter."+i.eventNamespace,E).bind("dragleave."+i.eventNamespace,l).bind("wasdropped."+i.eventNamespace,l);y=e('<div class="uploader" style="position:relative"/>').appendTo(z);u=e('<div class="upload-dropzone" style="display:none;position:absolute;top:0;left:0;z-index:2;width:100%;height:100%;text-align:center;min-height:50px">Drop files here</div>').bind("dragover."+i.eventNamespace,B).bind("dragenter."+i.eventNamespace,F).bind("dragleave."+i.eventNamespace,v).bind("drop."+i.eventNamespace,x).appendTo(y);o=e('<div class="upload-button" style="position:relative;overflow:hidden;text-align:center">'+i.buttonText+"</div>").appendTo(y);k=e('<input type="file" name="file" tabindex="-1"'+G+' style="position:absolute;top:0;right:0;margin:0;padding:0;opacity:0;font-size:118px;cursor:pointer"/>').bind("change."+i.eventNamespace,r).appendTo(o);D=e('<ul class="upload-list"/>').appendTo(y);if(!c){s=e('<form action="'+i.url+'" method="POST" enctype="multipart/form-data" target="upload-iframe-'+g+'"/>').appendTo(o).append(k);w=e('<iframe src="javascript:false;" id="upload-iframe-'+g+'" name="upload-iframe-'+g+'" style="display:none"/>').bind("load."+i.eventNamespace,A).appendTo("body")}g++};t()})}})(jQuery);